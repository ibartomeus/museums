---
title: "Museum specimens as baseline for assessing a potential global pollinator crisis"
author: "I. Bartomeus, J. Stavert, D. Ward, O. Aguado"
output: html_document
bibliography: data/references.xml
csl: data/philb_style.xml
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#req: 6000 words max. inc ref's 3 figures
#deadline: 1st April
```

##Abstract  

There is increasing concern about the decline of pollinators worldwide. However, despite reports that pollinator declines are widespread, data is scarce and often geographically and taxonomically biased. This limits robust inference about any potential “pollinator crisis”. Analysis of historical time series data is the most direct approach for assessing species declines, but long term monitoring programms targetting pollinators are scarce. However, non-structured and often opportunistic historical data collections are more frequent. In many instances, these data provide the only source of historical information serving as a baseline for identifying pollinator declines. Specimens historically collected and preserved in museums can provide information on where and when species were collected, in addition to other ecological information (e.g., historical species interactions and morphological traits). Here, we provide a synthesis of how researchers have used museum specimens to compare historical occurrences with current patterns to identify long-term changes in biodiversity, species abundances, body size and even pollination services. Despite recent advances, we show that information on the status and trends of most pollinators is absent, and that the lack of collection record data digitization is a key bottleneck, impeding progress in this field. We identify opportunities and limitations to progress in assessing pollinator declines at a global scale. Further, we demonstrate various approaches to analysing museum collection data by providing two contrasting case studies from distinct geographical regions (New Zealand and Spain) for which long-term pollinator declines have never been assessed. There is immense potential for museum specimens to play a central role in assessing the extent of the pollination crisis globally if we are able to make this data accesible and open.

## Introduction  

Animal pollinators are a critical component of both natural and agricultural ecosystems worldwide, given their role in plant reproduction [#@Ollerton2012] and food security [@Klein2007]. As with many other taxa, pollinators are vulnerable to a range of anthropogenic disturbances, which can cause local and regional population declines or even extinctions. This issue was identified several decades ago, and was popularized in 1996 by the influential book "the forgotten pollinators". However, these early accounts were somewhat anecdotal, given the lack of data on pollinator populations at that time. These initial claims triggered the first efforts to asses the problem, including the formation of a US National Academy of Science (NAS) panel in 2006, which was commissioned to assess the extent of pollinator declines. The NAS report concluded that "For most pollinator species [...] the paucity of long-term population data and the incomplete knowledge of even basic taxonomy and ecology make definitive assessment of status exceedingly difficult". Since then, studies on pollinator responses to various global change drivers have rapidly multiplied and researchers have developed a strong consensus that disturbances such as habitat destruction, land-use change, chemical exposure, exotic species and climate change are causing pollinator declines, and often act synergistically [@Goulson2015; @Potts2010]. Yet the current status and population trends of most pollinator species worldwide remain unknown. For example, a recent IUCN report concluded that even for Europe’s comparatively well-studied bee fauna, 60% of bee species [check number]() fell into the "Data Deficient" category [@Nieto2014]. For countries outside of Europe and the US, data on pollinator populations is almost non-existent.

One of the main barriers to identifying trends in pollinator populations is that pollinators are incredibly diverse and including bees, flies, butterflies, beetles, birds, bats and even lizards [#@Winfree2011]. Bees are generally regarded as the most important pollinator group due to their abundance, pollination efficiency and widespread distribution [@Ollerton2017]. However, bees are also extremely diverse, with more than 20,000 species currently described worldwide [#@PickeringAscher], and often require expert taxonomists for identification. The uneven distribution of bee researchers has resulted in geographical biases in bee decline research [#@Martinetal2012] and there are also taxonomic biases toward species that are easier to identify, such as bumblebees [#@ArcherOikos]. Another barrier to identifying pollinator declines is the difficulty in assessing population trends for these often highly mobile, short-lived and small organisms.  

One solution to overcoming these barriers has been to use space-for-time substitutions, where researchers compare pollinator populations across environmental gradients. Despite critiques on the robustness of this approach [@ref], this is the most extensive source of data on pollinator populations currently available. In Europe, researchers have recently estimated bee richness declines for every country using predictions generated from models using pollinator associations to different land uses [@DePalma2017]. A second promising method is assessing data collected in pollinator monitoring programs, which are often driven by citizen scientists. This approach was inspired by successful butterfly monitoring programs in countries such as the UK and is currently being extended to other pollinator taxa [@ref]. However, these programs require significant time to generate long-term datasets and cannot reveal anything about historic pollinator populations. Finally, the most practical approach for assessing long-term pollinator population trends is to use museum specimen collection data. The core aim of museums is to conserve and curate collections. Thus, they serve as a precious repository for specimens at the same time that they ensure high quality taxonomic identification [@primak]. Yet, the major bottleneck for researchers wanting to use data contained within museum collections is the digitization of collection data. Where digitization has been completed (e.g., US and Europe), the data provide a rich source of information and have allowed the assessment of the current statuses and long-term trends in pollinator populations (e.g., @Bartomeus2013a; #@Scheper2014). This is despite the fact that museum collections often have a number of biases [including...] [@Keil]. But in many cases, museum collections are the only data we have to reconstruct the past.

Regardless of the method, it is important for researchers to go beyond aspects of biodiversity focused solely in species richness. In addition to local (alpha) diversity and regional (gamma) diversity, we need to measure changes in turnover between sites (beta diversity), abundance of key species, and evenness of communities [@Winfree2015]. Environmental changes often results in few “winners” and many “losers” [@Bartomeus2013b]. Identifying winners and losers is critical as the few winner species are often exotic and represent a subset of traits that facilitate survival in highly modified environments [@Stavert2018]. These changes can have important flow on effects for pollination of native plant species and crops.  [Add something about traits of winners and losers?]()
https://www.sciencedirect.com/science/article/pii/S0065250417300296
[move this and expand to the discussion on the map?]()

## The use of museum specimens    
    
Digitizing old specimens is not a trivial task and requires expertise to (i) ensure proper taxonomic identification [@ref cory paper on taxonomy needs], (ii) geo-locate the coordinates of collection events [@ref and software] and (iii) store the data in a properly curated database [@ref on database management]. Undertaking this process for the thousands of specimens in museum collections can be a daunting task and requires specialized personnel. While some tasks can only be undertaken by people with specialist skills (e.g., taxonomists), new technologies and citizen science can speed up the collection digitization process. High resolution specimen photos and associated labels can be uploaded to the internet, where the job of image transcription can be distributed across hundreds or thousands of volunteers. In addition to this, new algorithms have been created that allow location geo-referencing based on vernacular names [@refs geonames, geoparser and opencage]. [Explain zooniverse, NZ initiative and how data can be validated... Is there anything on AI to automate the process? e.g. there is something on wing venation from photos at Netherlands. Can be mentioned?]

[how much do we want to extend on this? Is interesting info, but boring o read?]()  
 
##Current evidence on pollinatior declines    

Start with butterflies?

It is unsurprising that most evidence of pollinator declines is biased towards developed western countries, which have also been subject to extensive anthropogenic disturbance. For example, in the UK and the Netherlands, which have experienced a multitude of widespread anthropogenic changes, a citizen science based study using both observations and museum collections detected strong declines for bee, fly and flowering plant richness [@Biesmeijer2006]. However, it is important to note that even for these two countries, pollinator richness local estimates are biased toward large cities and regions dominated by agriculture, and data is lacking for natural areas. Further exploration of this dataset revealed that the declining trend for those pollinator taxa has attenuated in recent decades [@Carvalheiro2013]. More detailed trends for common bee species in the Netherlands have also been explored using museum specimens and confirm the link between simultaneous plant and pollinator declines [#@Scheper2014]. This study found that bee species with the strongest host plant preferences (i.e., specialists) displayed the strongest declines and thus were most threatened with extinction. [check this] [- EU: UK? Ollerton Science, Peter Keil flies? Moths? Buterflies! Add Ollerton paper!]()  

In comparison to local decline estimates, regional estimates for changes in species richness in the eastern US show a moderate decline in bee diversity [@Bartomeus2013a] and very few regional extinctions [@Colla2012]. These findings are in stark contrast with the widespread local extinctions reported by Burkle [@Burkle2013], who compared historical observations of bee occurrence in a large forested ecosystem with the present-day remaining forest remnants. However, it is important to note that this comparison focus only on the woodland remnants and does not take into account the new opportunistic bee species that use novel land-use types (@collado2018). Thus, local studies may detect richness declines, while regional richness remains relatively stable. In any case, there is strong concordance between local extinctions and regional declines [#@Bartomeus_Winfree2013], suggesting that local extinctions are indicators of regional population declines.

Outside of Europe and the US there are no studies on pollinator declines using historical museum collection records. [South Africa: Pauw, maybe with plants...]() . However, there are species-specific examples of historical (e.g., Bombus dalbhomi; Aizen). 

[add % in text also]()  

Justify focus on bees? We compiled all this information to show several worldwide maps showing knowledge about bee richness (a), Bee species richness changes (b), syrphid species richness changes (c) and butterfly species richness changes to highlight the little coverage that we have globally.


```{r map, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
library(rworldmap)
map <- read.csv("data/bee_richness.csv")
#Jamie, if you want, we could complete this data set based on the papers.
# If two estimates available for the same country, I will use two rows. 
# We can compute the mean or the max using reshape here.
# For studies reporting large regions within country this is ok, I think, but
# for studies reporting locations (like Burkle Science paper) the % richness loss would be inflated when scaling up... not sure how to add those up. Add a column maybe saying coverage
# country, region, individual sites.
#Bee richness can be gathered from Discover life webpage
#head(map)
map2 <- joinCountryData2Map(map, joinCode="NAME", nameJoinColumn = "country",
                            nameCountryColumn = "distribution")
#need to use ISO's to make sure we don't carry over NA's due to country misspellings
#have plotted countries with missing values as black (shows we have richness for pretty much everywhere)
map3 <- mapCountryData(map2, nameColumnToPlot = "species", missingCountryCol = "light grey",
               mapTitle = "Bee species richness", numCats = 25, catMethod = "pretty", addLegend = FALSE)
#change it to grey, blak was too contrasting!

#add a modified legend using the same initial parameters as mapCountryData
do.call(addMapLegend, c(map3, legendLabels="all", legendWidth=0.5))

#Nacho needs to correct for country size

```

Figure 1: Global map showing bee species richness. Countries without available data are coloured in grey. Data were downloaded from the Discover Life website.

```{r}
#plot for species declines??


```



## Beyond species occurrences  
 
Museum can provide valuable information besides species occurrence records, and this is important to take into account when digitizing the collections. This is specially relevant to identify mechanisms of decline and adaptation. One particularly important source of information is the date of capture, which has allowed to track phenological advances congruent with contemporary climate change [#@Bartomeus2011]. In addition, as mentioned above, insect pollinator labels often include as information the host plant where collected. This information is precious to understand past and present species interactions [#@Tylianakis2010ELE]. Even when the host plant is not noted, bee specimens often contain pollen loads trapped in the hairs, making possible to reconstruct past visitation events [#@kleinj_raemakers]. Finally, museum specimens can be measured for specific attributes and this has been done to show tongue length [#@refAlaskaScience] and body size [#@Oliveira] shrinkage with climate and land use change.   
[move this section below]()

## The way forward: Prioritizing the low hanging fruit.   

As illustrated in Figure 1, there is a paucity of countries for which museum data is available, and hence can be used as baseline for assessing pollinator population declines. While ideally, one would aim to digitize all museum records in the world, in the practical world this is unlikely to happen due mainly to funding constrains. Here we illustrate how this can be prioritized and optimized to encourage independent researchers to assess declines in its own country.   

Gbif [@ref] is a central repository centralizing occurrence data. Much of this data comes from museum, but it integrates several other sources. Alongside the popular statistical language R [@ref], gbif can be directly queried into your computer [#@rgbif] and check data availability for your region of interest. In Figure 2 we show the number of modern and historical bee records already available per country. While for some countries like UK and US the numbers are high in both axes, and hence, data can be potentially analyzed without further data collection efforts, most countries fall short in one or both of the axes. Hence, for countries with large number of recent records, researchers should prioritize the digitalization of old material to conduct their analysis. On the contrary, for countries with large number of historical records, re-surveys should be organized [e.g. #@cameron2013]. Interestingly, we show that >100 countries have less than 1000 records, making them unlikely candidates to study, but countries like X or X... Also note that historical records are not always in local museums, but many UK and US museums contain large collection of exotic pollinators.   

```{r low hanging fruits, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
library(rgbif)
apidae_key <- name_backbone(name="Apidae", rank = "family")$usageKey
andrenidae_key <- name_backbone(name="Andrenidae", rank = "family")$usageKey
halictidae_key <- name_backbone(name="Halictidae", rank = "family")$usageKey
colletidae_key <- name_backbone(name="Colletidae", rank = "family")$usageKey
megachilidae_key <- name_backbone(name="Megachilidae", rank = "family")$usageKey
stenotritidae_key <- name_backbone(name="Stenotritidae", rank = "family")$usageKey
melittidae_key <- name_backbone(name="Melittidae", rank = "family")$usageKey

keys <- c(apidae_key, andrenidae_key, halictidae_key, halictidae_key, colletidae_key,
          megachilidae_key, stenotritidae_key, melittidae_key)
#loop through all families, through all countries and store in datarame
country_codes <- isocodes$code 
lhf <- matrix(ncol = 1+(7*2), nrow = length(country_codes))
lhf <- as.data.frame(lhf)
colnames(lhf) <- c("country", "apidaepre1980", "andrenidaepre1980", "halictidaepre1980", "colletidaepre1980", 
                    "megachilidaepre1980", "stenotritidaepre1980", "melittidaepre1980",
                   "apidaepost1980", "andrenidaepost1980", "halictidaepost1980", "colletidaepost1980", 
                    "megachilidaepost1980", "stenotritidaepost1980", "melittidaepost1980")
for(i in 1:length(country_codes)){
    for(j in 1:length(keys)){
        lhf[i,1] <- country_codes[i]
        lhf[i,1+j] <- as.numeric(occ_count(taxonKey= keys[j],
                            from = 1980, to = 2018,
                            georeferenced=TRUE,
                            country = country_codes[i]))
        lhf[i,1+j+7] <- as.numeric(occ_count(taxonKey= keys[j],
                            from = 1850, to = 1980,
                            georeferenced=TRUE,
                            country = country_codes[i]))
    }
}
#very slow, we should save the data and load here when needed.
lhf$post1980 <- rowSums(lhf[,2:8])
lhf$pre1980 <- rowSums(lhf[,9:15])
write.csv(lhf, "data/rgbif_output.csv")
```

```{r plot rgbif, echo=FALSE, message=FALSE, warning=FALSE}
lhf <- read.csv("data/rgbif_output.csv", row.names = 1 )
#lhf
#head(lhf)
#str(lhf)
lhf <- lhf[order(lhf$pre1980),c(1,17,18)]
plot(lhf$post1980, lhf$pre1980, xlab = "post1980", ylab = "pre1980", col = as.factor(lhf$country), xlim = c(0,300000), ylim = c(0, 300000))
abline(h = 150000, v = 150000)
#plot needs legend by country, and to be ggplotted. Add some labels will be good, at least for ES and NZ, which we explore below.

```

Fig 2: number of bee occurrences pre 1980 and post 1980 in gbif. Upper right cuadrat are well covered countries, upper left cuadrat are countries that need resurvey of old sites. Lower right are sites which needs to dig museum records and lower left are countries hard to get data.    

Alternative plots:  
```{r alternative plot (bad), echo=FALSE, message=FALSE, warning=FALSE}
lhf$percent_post1980 <- lhf$post1980 / (lhf$pre1980+lhf$post1980)
lhf$percent_pre1980 <- lhf$pre1980 / (lhf$pre1980+lhf$post1980)

#plot(sort(lhf$percent_post1980), xlab = "post1980", ylab = "%", col = as.factor(lhf$country))
#Add country labels in x axes.

plot(log(lhf$post1980+1), log(lhf$pre1980+1), xlab = "post1980", ylab = "pre1980", col = as.factor(lhf$country))
abline(h = 8, v = 8)

```
% makes it unidimensional. Simply logging the data may work, we can point out % of countries with > 1000 records in either axes, for example, etc... Correcting for country size would be the best BUT I don't think richness and size have a linear relationship, so we should account for that then?    

Once museum collection datasets are made available, researchers needs to gauge any potential biases in the data. We explore this process with two contrasting examples from Spain and New Zealand. In the Spanish dataset, most of the data comes from a few specific locations and was collected by the same team of people. In this case, we contacted the original collectors to define their sampling protocols. We then resurveyed the same sites using the same protocols 20 years later. The New Zealand dataset includes a wide suite of collectors and collection locations. For this dataset, we ensured that there is no clear change to geographical [I haven’t actually looked at this as there weren’t and GPS coordinates in the data]() and taxonomic collection patterns through time. For example, some collectors may have targeted particular taxa, at specific locations or during certain time periods, which would represent a bias in the data. For these case studies, we provide annotated R scripts to analyse the different kinds of data (as described above). Essentially, these different analytical approaches allow us to reveal long-term trends in pollinator populations for regions with contrasting sampling histories. We hope this resource will encourage researchers to analyze data for regions where there is little current information on pollinator declines. [include a repository where people can contribute?]

## Case study one: Spain  

Spain provides an interesting study system because its natural habitats have been transformed extensively by humans, but land-use is not as intensive as many other European countries. In addition, Spain is a bee diversity hotspot and maintains a relatively heterogeneous landscape. Spain has already digitalized a decent amount of occurrence data both historical, and recent (Figure 2). However, visual inspection of the data reveals that the data is clustered around a few localities. Further, historic records do not spatially match recent records, making them difficult to compare. For this dataset, most of the old records are located around Valladolid and were collected by Enrique Asensio and his colaborators There has been no recent sampling of bees in this area. However we found that Enrique systematically sampled seven locations and that there was additional data available at the "Museo de Historia Nacional" and other minor collections. Digitization of these records, along with a re-survey of the locations that Enrique and his team collected from, provided us with an excellent dataset for a before and after comparison of bee communities at these sites.
 
In brief, we check sampling completeness at both time periods, and compare the richness level of each site before 1980 and after 1980 with a paired t-test. [Maybe more analyses arise...](). We show that ...    

Fig 3: Multi-panel figure  

##Case study two: NZ    
In contrast to Spain, Aotearoa-New Zealand is an isolated oceanic archipelago, with a distinctive pollinator biota and a unique history of human occupation. Much of Aotearoa-New Zealand’s pollinator fauna is also relatively depauperate. For example, Aotearoa-New Zealand has only 27 species of native bees [@Donovan2007], which is a fraction of nearby Australia’s c. 1600 species [@REF]. However, Aotearoa-New Zealand has a surprisingly high diversity of fly (Diptera) pollinators, which are important pollinators in many ecosystems [@Newstrom2005]. Thus, Aotearoa-New Zealand provides a unique system to study long-term changes in pollinator communities, and is unlike continental Europe and the US, which have been the focus of an overwhelming majority of pollinator decline studies.

In global terms, human colonisation of Aotearoa-New Zealand was relatively recent (c. 740 y) [@Wilmshurst2008]. Before human arrival, Aotearoa-New Zealand was predominately forested, but has since been dramatically altered by people. Early Māori settlers cleared forests by burning and more recently, European colonists cleared large tracts of remaining forests and drained low-lying wetlands for agriculture, mostly before 1900 [@Perry2014]. Therefore, human activity likely affected pollinator communities in Aotearoa-New Zealand long before surveys and collections began. Nevertheless, we can use museum records to identify trends in pollinator communities during Aotearoa-New Zealand’s more recent history.

We used New Zealand bee collection records gathered from multiple sources, including university, research institute, museum and private collections. Fly pollinator data was obtained from six participating New Zealand museums and covers two families (Calliphoridae and Syrphidae) that contain important fly pollinators. Collections for the bee and fly datasets span over 100 years (early 1900s to late 2000s).

First, we filtered our original datasets so that data used for analyses only included unique collection events. To do this, we removed specimens collected at the same location, on the same date, and by the same collector. We found our data had reasonable coverage across time periods, although there was a peak in collection occurrences from 1960-1980. We accounted for differences in collection effort through binning collection records by time so that each bin had a similar number of records but a different number of years [see @Bartomeus2013a for further details]. We then estimated richness for each time period bin by rarefying all bins to an equal number of specimens and calculated the mean species richness ±SE for each bin. Finally, we estimated the significance of change in richness using a permutation test that randomly reordered time periods and calculated the correlation between time period and species richness. Thus reported P-values were the proportion of permutations that had higher or lower correlations compared to the correlation between richness and the actual chronological time period sequence.

To determine if the probability of finding a species in the collection changed over time, we used a general linear model with a binomial distribution and a logit link. [should we analyse natives and exotics together or separately?]. For species that showed overdispersion, we used a quasi-binomial distribution. Further, we only included species in this analysis for which we had 30 or more records. To account for differences in sampling effort between years, we weighted each year by the total number of samples collected in that year. 

We found that rarefied richness for both native and exotic bees increased overtime, but these trends were non-significant (P-values for both groups > 0.05). In contrast, native fly richness declined, whereas exotic fly richness increased, although results for these groups were also non-significant (P-values for both groups > 0.05). Note that rarefied richness is sensitive to species evenness...

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
library(plyr)
library(dplyr)
library(reshape2)
library(ggplot2)
library(maps)
library(vegan)

########################################
#read in NZ bee data
########################################

d <- read.csv("data/NZBees_allrecords.csv", header = TRUE, sep = ",", na.strings=c("","NA"))

#select required variables
d <- select(d, one_of(c("species", "date", "locality", "collector", "collection", "method", "exotic_native")))
d <- na.omit(d) #remove NAs

#remove honeybees
d$species <- as.factor(d$species)
d <- d[ ! d$species %in% c("Apis mellifera"), ]
d$species <- droplevels(d$species)

#need to correct space between genus and species
#levels(d$species)
#d$Gen_sp <- paste(d$NameGenus, d$NameSpecies, sep = "_")
d$Gen_sp <- d$species
#sort(table(d$Gen_sp))
#sum(table(d$Gen_sp))
#head(d)

#standardise dates
date2 <- strptime(d$date, "%d/%m/%Y")
d$jday <- date2$yday
d$year <- 1900 + date2$year
d$month <- date2$mon + 1
#head(d$month)

#select fields to be independent
#completeFun <- function(data, desiredCols) {
#  completeVec <- complete.cases(data[, desiredCols])
#  return(data[completeVec, ])
#}

#d <- completeFun(d, c("day", "month", "year"))
uni <- as.data.frame(cbind(d$Gen_sp, d$locality, d$collector, d$jday, d$year))
dup <- duplicated(uni)

# remove duplicates
d2 <- d[-which(dup == TRUE),]

#retain only sweep netting and no data
#keep <- c("sweep", "no_data") #method is missing for a number of records
#d2 <- d2[d2$method %in% keep, ]

native <- filter(d2, exotic_native == "native") %>% droplevels()
exotic <- filter(d2, exotic_native == "exotic") %>% droplevels()

#############################################
#Resampling Analysis for natives species 
#############################################

par(mfrow = c(2,2), mar = c(4,4,2,1))

#fin year = 0 quick and dirty
#length(which(native$year < 1900))
native <- subset(native, year > 1900)
for (i in 3:10){
    break1 <- quantile(native$year, probs = seq(0,1,1/i), na.rm = TRUE)
    lab <- c(1:i)
    for(j in 1:i){
        lab[j] <- paste(as.numeric(break1)[j],as.numeric(break1)[j+1], sep = "-")
    }
    native$time_period_quant  <- cut(native$year, breaks = break1, labels = lab)
    comm2 <- table(native$time_period_quant, factor(native$Gen_sp))
    (x2 <- rarefy(comm2,150, se = TRUE)) #same result as my resampling...
    #rar[[i-2+10]] <- x2
    #str(x2)
    time <- c(1:i)
    for(j in 1:i){
        time[j] <- (as.numeric(break1)[j] + as.numeric(break1)[j+1])/2
    }
    xx2 <- as.data.frame(x2)[1,]
    se <- as.data.frame(x2)[2,]
    #if(i == 3){
        #rarecurve(comm2, label = TRUE, step = 20, cex = 0.1, las = 2)
        #abline(v = 150)}
    m <- lm(t(xx2)~ time)
    summary(m)
    corr <- cor(t(xx2), time, use = "complete.obs")
    cor_dis <- c(1:1000)
    for (k in 1:1000){
        cor_dis[k] <- cor(sample(t(xx2),i), time, use = "complete.obs")
    }
    #hist(cor_dis)
    #lines(c(corr, corr), c(0,200), col = "red")
    (p <- pnorm(corr, mean = mean(cor_dis), sd = sd(cor_dis)))
    #with lm
    #if(summary(m)$coef[8]> 0.05 | is.na(summary(m)$coef[8]) == TRUE){
    #abline(m, lty = 2)}
    #else{
    #abline(m, lty = 1)}    
    #with corrs
    #if(p > 0.05){
        #abline(m, lty = 2)}
    #else{
        #abline(m, lty = 1)}    
    #if(i == 10){
        #rarecurve(comm2, label = TRUE, step = 20, cex = 0.1, las = 2)
        #abline(v = 150)}    
    #rarecurve(comm2)
    #abline(v = 1000)
    
}
    plot(time,t(xx2), xlab = "", las = 2, ylab = "Number of native bee species", main = "", xaxt = "n", ylim = c(min(xx2, na.rm = TRUE)- max(se), max(xx2, na.rm = TRUE)+ max(se)))
    axis(1, at = time ,labels = lab, las = 2, cex.axis = 0.7)
    arrows(time,as.numeric(xx2)+as.numeric(se), time, as.numeric(xx2)-as.numeric(se), angle=90, length = 0)
    abline(m, lty = 2)

#############################################
#Resampling Analysis for exotic species 
#############################################

#length(which(exotic$year < 1900))
exotic <- subset(exotic, year > 1900)
for (i in 3:6){ #error saying break are not unique - how to fix?
    break1 <- quantile(exotic$year, probs = seq(0,1,1/i), na.rm = TRUE)
    lab <- c(1:i)
    for(j in 1:i){
        lab[j] <- paste(as.numeric(break1)[j],as.numeric(break1)[j+1], sep = "-")
    }
    exotic$time_period_quant  <- cut(exotic$year, breaks = break1, labels = lab)
    comm2 <- table(exotic$time_period_quant, factor(exotic$Gen_sp))
    (x2 <- rarefy(comm2,25, se = TRUE)) #same result as my resampling...
    #rar[[i-2+10]] <- x2
    #str(x2)
    time <- c(1:i)
    for(j in 1:i){
        time[j] <- (as.numeric(break1)[j] + as.numeric(break1)[j+1])/2
    }
    xx2 <- as.data.frame(x2)[1,]
    se <- as.data.frame(x2)[2,]
    #if(i == 3){
        #rarecurve(comm2, label = TRUE, step = 20, cex = 0.1, las = 2)
        #abline(v = 25)}
    m <- lm(t(xx2)~ time)
    summary(m)
    corr <- cor(t(xx2), time, use = "complete.obs")
    cor_dis <- c(1:1000)
    for (k in 1:1000){
        cor_dis[k] <- cor(sample(t(xx2),i), time, use = "complete.obs")
    }
    #hist(cor_dis)
    #lines(c(corr, corr), c(0,200), col = "red")
    (p <- pnorm(corr, mean = mean(cor_dis), sd = sd(cor_dis)))
    #with lm
    #if(summary(m)$coef[8]> 0.05 | is.na(summary(m)$coef[8]) == TRUE){
    #abline(m, lty = 2)}
    #else{
    #abline(m, lty = 1)}    
    #with corrs
    #if(p > 0.05){
      # abline(m, lty = 2)}
   # else{
       # abline(m, lty = 1)}    
   # if(i == 10){
        #rarecurve(comm2, label = TRUE, step = 20, cex = 0.1, las = 2)
        #abline(v = 25)}    
    #rarecurve(comm2)
    #abline(v = 1000)
}
    plot(time,t(xx2), xlab = "", las = 2, ylab = "Number of exotic bee species", main = "", xaxt = "n", ylim = c(min(xx2, na.rm = TRUE)- max(se), max(xx2, na.rm = TRUE)+ max(se)))
    axis(1, at = time ,labels = lab, las = 2, cex.axis = 0.7)
    arrows(time,as.numeric(xx2)+as.numeric(se), time, as.numeric(xx2)-as.numeric(se), angle=90, length = 0)
    abline(m, lty = 2)

############################################
#resampling analysis for flies
############################################
    
    #load data
    d <- read.csv(file = "data/NZ_fly_pollinators.csv", header = TRUE, sep = ",", na.strings=c("","NA"))
    
    #remove unidentified species
    completeFun <- function(data, desiredCols) {
        completeVec <- complete.cases(data[, desiredCols])
        return(data[completeVec, ])
    }
    
    d <- completeFun(d, "exotic_native")
    
    d$Gen_sp <- paste(d$NameGenus, d$NameSpecies, sep = "_")
    
    #date
    date2 <- strptime(d$CollectionDateISOFrom, "%Y\\%m\\%d")
    d$jday <- date2$yday
    d$year <- 1900 + date2$year
    d$month <- date2$mon + 1
    
    #select fields to be independent
    #two approaches lat = 0 and others
    lat <- subset(d, Lat != 0 & is.na(year) == F)#remove all records with no latitude recording
    #unique fields by lata, long, day of the year and year
    uni <- as.data.frame(cbind(lat$Gen_sp, lat$Lat, lat$Long, lat$jday, lat$year))
    dup <- duplicated(uni)
    #d2 <- d[-which(dup == TRUE),]
    # lat/long = 0
    #lat0 <- subset(d, Dlat == 0 & is.na(year) == F)
    #str(lat0)
    #uni2 <- as.data.frame(cbind(lat0$Gen, lat0$sp, lat0$LocalityStr, lat0$SubDivStr, lat0$StateProv, lat0$Country, lat0$jday, lat0$year))
    #str(uni2)
    #dup2 <- duplicated(uni2)
    
    # remove duplicates
    lat <- lat[-which(dup == TRUE),]
    #lat0 <- lat0[-which(dup2 == TRUE),]
    #d2 <- rbind(lat,lat0)
    d2 <- lat
    native <- filter(d2, exotic_native == "native") %>% droplevels()
    exotic <- filter(d2, exotic_native == "exotic") %>% droplevels()
    
    #length(which(native$year < 1900))
    native <- subset(native, year > 1900)
    for (i in 3:10){
        break1 <- quantile(native$year, probs = seq(0,1,1/i))
        lab <- c(1:i)
        for(j in 1:i){
            lab[j] <- paste(as.numeric(break1)[j],as.numeric(break1)[j+1], sep = "-")
        }
        native$time_period_quant  <- cut(native$year, breaks = break1, labels = lab)
        comm2 <- table(native$time_period_quant, factor(native$Gen_sp))
        (x2 <- rarefy(comm2,100, se = TRUE)) #same result as my resampling...
        #rar[[i-2+10]] <- x2
        #str(x2)
        time <- c(1:i)
        for(j in 1:i){
            time[j] <- (as.numeric(break1)[j] + as.numeric(break1)[j+1])/2
        }
        xx2 <- as.data.frame(x2)[1,]
        se <- as.data.frame(x2)[2,]
        #if(i == 3){
            #rarecurve(comm2, label = TRUE, step = 20, cex = 0.1, las = 2)
            #abline(v = 100)}
        m <- lm(t(xx2)~ time)
        summary(m)
        corr <- cor(t(xx2), time, use = "complete.obs")
        cor_dis <- c(1:1000)
        for (k in 1:1000){
            cor_dis[k] <- cor(sample(t(xx2),i), time, use = "complete.obs")
        }
        #hist(cor_dis)
        #lines(c(corr, corr), c(0,200), col = "red")
        (p <- pnorm(corr, mean = mean(cor_dis), sd = sd(cor_dis)))
        #with lm
        #if(summary(m)$coef[8]> 0.05 | is.na(summary(m)$coef[8]) == TRUE){
        #abline(m, lty = 2)}
        #else{
        #abline(m, lty = 1)}    
        #with corrs
        #if(p > 0.05){
           # abline(m, lty = 2)}
        #else{
            #abline(m, lty = 1)}    
        #if(i == 10){
            #rarecurve(comm2, label = TRUE, step = 20, cex = 0.1, las = 2)
            #abline(v = 40)}	
        #rarecurve(comm2)
        #abline(v = 1000)
    }
    
    plot(time,t(xx2), xlab = "", las = 2, ylab = "Number of native fly species", main = "", xaxt = "n", ylim = c(min(xx2, na.rm = TRUE)- max(se), max(xx2, na.rm = TRUE)+ max(se)))
    axis(1, at = time ,labels = lab, las = 2, cex.axis = 0.7)
    arrows(time,as.numeric(xx2)+as.numeric(se), time, as.numeric(xx2)-as.numeric(se), angle=90, length = 0)
    abline(m, lty = 2)
    
    ##########################################################################
    #Resampling Analysis for exotic flies
    ##########################################################################
    
    #fin year = 0 quick and dirty
    #length(which(exotic$year < 1900))
    exotic <- subset(exotic, year > 1900)
    for (i in 3:10){
        break1 <- quantile(exotic$year, probs = seq(0,1,1/i)) #breaks can be equal, un tie those
        if(any(duplicated(break1))){
            break1[duplicated(break1)] <- break1[duplicated(break1)]+1
        }
        if(any(duplicated(break1))){
            break1[duplicated(break1)] <- break1[duplicated(break1)]+1
        }
        lab <- c(1:i)
        for(j in 1:i){
            lab[j] <- paste(as.numeric(break1)[j],as.numeric(break1)[j+1], sep = "-")
        }
        exotic$time_period_quant  <- cut(exotic$year, breaks = break1, labels = lab)
        comm2 <- table(exotic$time_period_quant, factor(exotic$Gen_sp))
        (x2 <- rarefy(comm2,20, se = TRUE)) #same result as my resampling...
        #rar[[i-2+10]] <- x2
        #str(x2)
        time <- c(1:i)
        for(j in 1:i){
            time[j] <- (as.numeric(break1)[j] + as.numeric(break1)[j+1])/2
        }
        xx2 <- as.data.frame(x2)[1,]
        se <- as.data.frame(x2)[2,]
        #if(i == 3){
            #rarecurve(comm2, label = TRUE, step = 20, cex = 0.1, las = 2)
            #abline(v = 20)}
        m <- lm(t(xx2)~ time)
        summary(m)
        corr <- cor(t(xx2), time, use = "complete.obs")
        cor_dis <- c(1:1000)
        for (k in 1:1000){
            cor_dis[k] <- cor(sample(t(xx2),i), time, use = "complete.obs")
        }
        #hist(cor_dis)
        #lines(c(corr, corr), c(0,200), col = "red")
        (p <- pnorm(corr, mean = mean(cor_dis), sd = sd(cor_dis)))
        #with lm
        #if(summary(m)$coef[8]> 0.05 | is.na(summary(m)$coef[8]) == TRUE){
        #abline(m, lty = 2)}
        #else{
        #abline(m, lty = 1)}    
        #with corrs
        #if(p > 0.05){
            #abline(m, lty = 2)}
        #else{
            #abline(m, lty = 1)}    
        #if(i == 10){
            #rarecurve(comm2, label = TRUE, step = 20, cex = 0.1, las = 2)
            #abline(v = 40)}	
        #rarecurve(comm2)
        #abline(v = 1000)
    }
    
    plot(time,t(xx2), xlab = "", las = 2, ylab = "Number of exotic fly species", main = "", xaxt = "n", ylim = c(min(xx2, na.rm = TRUE)- max(se), max(xx2, na.rm = TRUE)+ max(se)))
    axis(1, at = time ,labels = lab, las = 2, cex.axis = 0.7)
    arrows(time,as.numeric(xx2)+as.numeric(se), time, as.numeric(xx2)-as.numeric(se), angle=90, length = 0)
    abline(m, lty = 2)
    
    ##########################################################################
    #END
    ##########################################################################

```

Figure 4. Changes in species richness for different pollinator groups in New Zealand over time. All trends were non-signifficant.

Changes in species relative abundances over time

We found that 10 out of 27 bee species increased in relative abundance over time (nine native and one exotic) and three bee species declined in relative abundance (one native and two exotic) (Figure 3). Interestingly, the two exotic bee species that declined in relative abundance were both Bombus. Native bees that increased in relative abundance were mostly from the genus Leioproctus. Only two out of 14 fly species increased in relative abundance, both of which were exotic, whereas four species decreased in abundance (three native and one exotic). Native flies that decreased in relative abundance were all Syrphidae in the genus Helophilus.

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

############################################
#analyse the bee dataset
############################################

d <- read.csv("data/NZBees_allrecords.csv", header = TRUE, sep = ",", na.strings=c("","NA"))

#select required variables
d <- select(d, one_of(c("species", "date", "locality", "collector", "collection", "method", "exotic_native")))
d <- na.omit(d) #remove NAs

#remove honeybees
d$species <- as.factor(d$species)
d <- d[ ! d$species %in% c("Apis mellifera"), ]
d$species <- droplevels(d$species)

#need to correct space between genus and species
#levels(d$species)
#d$Gen_sp <- paste(d$NameGenus, d$NameSpecies, sep = "_")
d$Gen_sp <- d$species
#sort(table(d$Gen_sp))
#sum(table(d$Gen_sp))
#head(d)

#standardise dates
date2 <- strptime(d$date, "%d/%m/%Y")
d$jday <- date2$yday
d$year <- 1900 + date2$year
d$month <- date2$mon + 1
#head(d$month)

#select fields to be independent
#completeFun <- function(data, desiredCols) {
#  completeVec <- complete.cases(data[, desiredCols])
#  return(data[completeVec, ])
#}

#d <- completeFun(d, c("day", "month", "year"))
uni <- as.data.frame(cbind(d$Gen_sp, d$locality, d$collector, d$jday, d$year))
#str(uni)
dup <- duplicated(uni)

# remove duplicates
d2 <- d[-which(dup == TRUE),]

#retain only sweep netting and no data
#keep <- c("sweep", "no_data") #method is missing for a number of records
#d2 <- d2[d2$method %in% keep, ]

#create dataframes to remove species with less that 30 records
no.ind <- as.data.frame(sort(table(d2$Gen_sp))) #14 species with more than 30 datapoints
species.remove <- filter(no.ind, Freq < 30)#create df with species that have less than 30 records
#visualize the data: #not with bees
#plot(d2$Long, d2$Lat)
#library(maps)
#map("world", col="red", add=TRUE)

#plot(d2$Long, d2$Lat, ylim = c(-50,-32), xlim = c(163,183))
#map("world", col="red", add=TRUE) #fix wrong lat/long

#############################
# species models
#############################
#collection history per year
B <- d2
frq <- table(factor(B$Gen_sp),factor(B$year))
bin <- ifelse(frq > 0, 1, 0) 


#i=1
#last_year2 <- c(1:length(bin[,1]))
#for (i in 1:length(bin[,1])){
#  bin2 <- bin[i,-which(bin[i,] == 0)]
#  last_year2[i] <- names(tail(bin2,1))
#}
#l_yBB <- data.frame(Gen_sp = rownames(bin), last_year = last_year2)
##l_yBB #broken at i = 5 check.

#year vector
y <- as.numeric(colnames(bin))


#weights per year (specimens collected/max specimens collected)

effort <- c(1:length(y))
wei <- c(c(1:length(y)))
for (i in 1:length(y)){effort[i] <- sum(frq[,i])}
for (i in 1:length(y)){wei[i] <- sum(frq[,i])/max(effort)}

#### estimates for all sp
#mB <- frq[,c(1:11)]
#colnames(mB) <- c("estimate_bin", "SE_bin", "p_bin","estimate_frq", "SE_frq", "p_frq", "pred1880", "pred 2010","pred1880SE", "pred 2010SE","Logit")
mB <- frq[,c(1:10)]
colnames(mB) <- c("estimate_bin", "SE_bin", "p_bin","estimate_frq", "SE_frq", "p_frq", "pred1880", "pred 2015","pred1880SE", "pred 2015SE")
try(for (i in 1:length(frq[,1])){
    mB[i,1] <- summary(glm(bin[i,] ~ y, family = binomial(link=logit), na.action=na.omit, weight = wei))$coefficients[2]
    mB[i,2] <- summary(glm(bin[i,] ~ y, family = binomial(link=logit), na.action=na.omit, weight = wei))$coefficients[4]
    mB[i,3] <- summary(glm(bin[i,] ~ y, family = binomial(link=logit), na.action=na.omit, weight = wei))$coefficients[8]
    if (deviance(glm(cbind(frq[i,], effort-frq[i,]) ~ y, family = binomial(link=logit), na.action=na.omit))/df.residual(glm(cbind(frq[i,], effort-frq[i,]) ~ y, family = binomial(link=logit), na.action=na.omit)) > 1.5) {
        mB[i,4] <- summary(glm(cbind(frq[i,], effort-frq[i,]) ~ y, family = quasibinomial(link=logit), na.action=na.omit))$coefficients[2]
        mB[i,5] <- summary(glm(cbind(frq[i,], effort-frq[i,]) ~ y, family = quasibinomial(link=logit), na.action=na.omit))$coefficients[4]
        mB[i,6] <- summary(glm(cbind(frq[i,], effort-frq[i,]) ~ y, family = quasibinomial(link=logit), na.action=na.omit))$coefficients[8]
        mB[i,7] <- predict(glm(cbind(frq[i,], effort-frq[i,]) ~ y, family = quasibinomial(link=logit), na.action=na.omit), newdata = data.frame(y = c(1880,2015)), type = "response", se.fit = TRUE)$fit[1]
        mB[i,8] <- predict(glm(cbind(frq[i,], effort-frq[i,]) ~ y, family = quasibinomial(link=logit), na.action=na.omit), newdata = data.frame(y = c(1880,2015)), type = "response", se.fit = TRUE)$fit[2]
        mB[i,9] <- predict(glm(cbind(frq[i,], effort-frq[i,]) ~ y, family = quasibinomial(link=logit), na.action=na.omit), newdata = data.frame(y = c(1880,2015)), type = "response", se.fit = TRUE)$se.fit[1]
        mB[i,10] <- predict(glm(cbind(frq[i,], effort-frq[i,]) ~ y, family = quasibinomial(link=logit), na.action=na.omit), newdata = data.frame(y = c(1880,2015)), type = "response", se.fit = TRUE)$se.fit[2]
    }
    #mB[i,11] <- plogis(summary(glm(cbind(frq[i,], effort-frq[i,]) ~ y, family = quasibinomial(link=logit), na.action=na.omit))$coefficients[2])-0.5
    else {
        mB[i,4] <- summary(glm(cbind(frq[i,], effort-frq[i,]) ~ y, family = binomial(link=logit), na.action=na.omit))$coefficients[2]
        mB[i,5] <- summary(glm(cbind(frq[i,], effort-frq[i,]) ~ y, family = binomial(link=logit), na.action=na.omit))$coefficients[4]
        mB[i,6] <- summary(glm(cbind(frq[i,], effort-frq[i,]) ~ y, family = binomial(link=logit), na.action=na.omit))$coefficients[8]
        mB[i,7] <- predict(glm(cbind(frq[i,], effort-frq[i,]) ~ y, family = binomial(link=logit), na.action=na.omit), newdata = data.frame(y = c(1880,2015)), type = "response", se.fit = TRUE)$fit[1]
        mB[i,8] <- predict(glm(cbind(frq[i,], effort-frq[i,]) ~ y, family = binomial(link=logit), na.action=na.omit), newdata = data.frame(y = c(1880,2015)), type = "response", se.fit = TRUE)$fit[2]
        mB[i,9] <- predict(glm(cbind(frq[i,], effort-frq[i,]) ~ y, family = binomial(link=logit), na.action=na.omit), newdata = data.frame(y = c(1880,2015)), type = "response", se.fit = TRUE)$se.fit[1]
        mB[i,10] <- predict(glm(cbind(frq[i,], effort-frq[i,]) ~ y, family = binomial(link=logit), na.action=na.omit), newdata = data.frame(y = c(1880,2015)), type = "response", se.fit = TRUE)$se.fit[2]    	
    }
})

############################################
#plot model estimates and predictions
############################################

#prepare dataframe
bee.est <- as.data.frame(mB)
bee.est.cast <- dcast(bee.est, Var1 ~ Var2, value.var="Freq")
bee.est.cast <- bee.est.cast[!(bee.est.cast$Var1 %in% species.remove$Var1),]

#add direction change based on estimate and p-value
bee.est.cast$change_in_occurance <- with(bee.est.cast, ifelse(
    estimate_frq < 0 & p_frq < 0.05, 'Negative', ifelse(
        p_frq >= 0.05, 'Stable', ifelse(
            estimate_frq > 0 & p_frq >= 0.05, 'whoops', 'Positive'))))
bee.est.cast$taxa <- "Bee"

############################################
#analyse fly dataset
############################################

#load data
d <- read.csv(file = "data/NZ_fly_pollinators.csv", header = TRUE, sep = ",", na.strings=c("","NA"))

#remove unidentified species
completeFun <- function(data, desiredCols) {
    completeVec <- complete.cases(data[, desiredCols])
    return(data[completeVec, ])
}

d <- completeFun(d, "exotic_native")

d$Gen_sp <- paste(d$NameGenus, d$NameSpecies, sep = "_")

#date
date2 <- strptime(d$CollectionDateISOFrom, "%Y\\%m\\%d")
d$jday <- date2$yday
d$year <- 1900 + date2$year
d$month <- date2$mon + 1

#select fields to be independent
#two approaches lat = 0 and others
lat <- subset(d, Lat != 0 & is.na(year) == F)#remove all records with no latitude recording
#unique fields by lata, long, day of the year and year
uni <- as.data.frame(cbind(lat$Gen_sp, lat$Lat, lat$Long, lat$jday, lat$year))
dup <- duplicated(uni)
#d2 <- d[-which(dup == TRUE),]
# lat/long = 0
#lat0 <- subset(d, Dlat == 0 & is.na(year) == F)
#str(lat0)
#uni2 <- as.data.frame(cbind(lat0$Gen, lat0$sp, lat0$LocalityStr, lat0$SubDivStr, lat0$StateProv, lat0$Country, lat0$jday, lat0$year))
#str(uni2)
#dup2 <- duplicated(uni2)

# remove duplicates
lat <- lat[-which(dup == TRUE),]
#lat0 <- lat0[-which(dup2 == TRUE),]
#d2 <- rbind(lat,lat0)
d2 <- lat
no.ind <- as.data.frame(sort(table(d2$Gen_sp))) #14 species with more than 30 datapoints
species.remove <- filter(no.ind, Freq < 30)#create df with species that have less than 30 records

no.ind.fly <- as.data.frame(sort(table(d2$Gen_sp))) #14 species with more than 30 datapoints
species.remove.fly <- filter(no.ind.fly, Freq < 30)#create df with species that have less than 30 records
colnames(species.remove.fly)[1] <- "Gen_sp"

##########################################################################
#species models
##########################################################################

#collection history per year
B <- d2
frq <- table(factor(B$Gen_sp),factor(B$year))
bin <- ifelse(frq > 0, 1, 0) 

#i=1
#last_year2 <- c(1:length(bin[,1]))
#for (i in 1:length(bin[,1])){
   #bin2 <- bin[i,-which(bin[i,] == 0)]
    #last_year2[i] <- names(tail(bin2,1))
#}
#l_yBB <- data.frame(Gen_sp = rownames(bin), last_year = last_year2)
#l_yBB #broken at i = 5 check.

#year vector
y <- as.numeric(colnames(bin))


#weights per year (specimens collected/max specimens collected)

effort <- c(1:length(y))
wei <- c(c(1:length(y)))
for (i in 1:length(y)){effort[i] <- sum(frq[,i])}
for (i in 1:length(y)){wei[i] <- sum(frq[,i])/max(effort)}


##########################################################################
#estimates for all sp
##########################################################################

#mB <- frq[,c(1:11)]
#colnames(mB) <- c("estimate_bin", "SE_bin", "p_bin","estimate_frq", "SE_frq", "p_frq", "pred1880", "pred 2010","pred1880SE", "pred 2010SE","Logit")
mB <- frq[,c(1:10)]
colnames(mB) <- c("estimate_bin", "SE_bin", "p_bin","estimate_frq", "SE_frq", "p_frq", "pred1880", "pred 2015","pred1880SE", "pred 2015SE")
try(for (i in 1:length(frq[,1])){
    mB[i,1] <- summary(glm(bin[i,] ~ y, family = binomial(link=logit), na.action=na.omit, weight = wei))$coefficients[2]
    mB[i,2] <- summary(glm(bin[i,] ~ y, family = binomial(link=logit), na.action=na.omit, weight = wei))$coefficients[4]
    mB[i,3] <- summary(glm(bin[i,] ~ y, family = binomial(link=logit), na.action=na.omit, weight = wei))$coefficients[8]
    if (deviance(glm(cbind(frq[i,], effort-frq[i,]) ~ y, family = binomial(link=logit), na.action=na.omit))/df.residual(glm(cbind(frq[i,], effort-frq[i,]) ~ y, family = binomial(link=logit), na.action=na.omit)) > 1.5) {
        mB[i,4] <- summary(glm(cbind(frq[i,], effort-frq[i,]) ~ y, family = quasibinomial(link=logit), na.action=na.omit))$coefficients[2]
        mB[i,5] <- summary(glm(cbind(frq[i,], effort-frq[i,]) ~ y, family = quasibinomial(link=logit), na.action=na.omit))$coefficients[4]
        mB[i,6] <- summary(glm(cbind(frq[i,], effort-frq[i,]) ~ y, family = quasibinomial(link=logit), na.action=na.omit))$coefficients[8]
        mB[i,7] <- predict(glm(cbind(frq[i,], effort-frq[i,]) ~ y, family = quasibinomial(link=logit), na.action=na.omit), newdata = data.frame(y = c(1880,2015)), type = "response", se.fit = TRUE)$fit[1]
        mB[i,8] <- predict(glm(cbind(frq[i,], effort-frq[i,]) ~ y, family = quasibinomial(link=logit), na.action=na.omit), newdata = data.frame(y = c(1880,2015)), type = "response", se.fit = TRUE)$fit[2]
        mB[i,9] <- predict(glm(cbind(frq[i,], effort-frq[i,]) ~ y, family = quasibinomial(link=logit), na.action=na.omit), newdata = data.frame(y = c(1880,2015)), type = "response", se.fit = TRUE)$se.fit[1]
        mB[i,10] <- predict(glm(cbind(frq[i,], effort-frq[i,]) ~ y, family = quasibinomial(link=logit), na.action=na.omit), newdata = data.frame(y = c(1880,2015)), type = "response", se.fit = TRUE)$se.fit[2]
    }
    #mB[i,11] <- plogis(summary(glm(cbind(frq[i,], effort-frq[i,]) ~ y, family = quasibinomial(link=logit), na.action=na.omit))$coefficients[2])-0.5
    else {
        mB[i,4] <- summary(glm(cbind(frq[i,], effort-frq[i,]) ~ y, family = binomial(link=logit), na.action=na.omit))$coefficients[2]
        mB[i,5] <- summary(glm(cbind(frq[i,], effort-frq[i,]) ~ y, family = binomial(link=logit), na.action=na.omit))$coefficients[4]
        mB[i,6] <- summary(glm(cbind(frq[i,], effort-frq[i,]) ~ y, family = binomial(link=logit), na.action=na.omit))$coefficients[8]
        mB[i,7] <- predict(glm(cbind(frq[i,], effort-frq[i,]) ~ y, family = binomial(link=logit), na.action=na.omit), newdata = data.frame(y = c(1880,2015)), type = "response", se.fit = TRUE)$fit[1]
        mB[i,8] <- predict(glm(cbind(frq[i,], effort-frq[i,]) ~ y, family = binomial(link=logit), na.action=na.omit), newdata = data.frame(y = c(1880,2015)), type = "response", se.fit = TRUE)$fit[2]
        mB[i,9] <- predict(glm(cbind(frq[i,], effort-frq[i,]) ~ y, family = binomial(link=logit), na.action=na.omit), newdata = data.frame(y = c(1880,2015)), type = "response", se.fit = TRUE)$se.fit[1]
        mB[i,10] <- predict(glm(cbind(frq[i,], effort-frq[i,]) ~ y, family = binomial(link=logit), na.action=na.omit), newdata = data.frame(y = c(1880,2015)), type = "response", se.fit = TRUE)$se.fit[2]    	
    }
})

##########################################################################
#plot model estimates and predictions
##########################################################################

#prepare dataframe
fly.est <- as.data.frame(mB)
fly.est.cast <- dcast(fly.est, Var1 ~ Var2, value.var="Freq")
fly.est.cast <- fly.est.cast[!(fly.est.cast$Var1 %in% species.remove$Var1),]

#add direction change based on estimate and p-value
fly.est.cast$change_in_occurance <- with(fly.est.cast, ifelse(
    estimate_frq < 0 & p_frq < 0.05, 'Negative', ifelse(
        p_frq >= 0.05, 'Stable', ifelse(
            estimate_frq > 0 & p_frq >= 0.05, 'whoops', 'Positive'))))
fly.est.cast$taxa <- "Fly"

#merge bee and fly estimate datasets
est.all <- rbind(fly.est.cast,bee.est.cast)
est.all$Var1 <- gsub("_", " ", est.all$Var1)

####################################################
#plot frequency estimates
####################################################

p <- ggplot(est.all, aes(Var1, estimate_frq, group=taxa))
p <- p + xlab(NULL) + ylab("Frequency estimate")
p <- p + theme(text = element_text(size=16))
p <- p + facet_wrap(~taxa,scales = "free_x")
p <- p + geom_point(aes(colour=change_in_occurance), size = 2)
p <- p + geom_errorbar(aes(ymin=estimate_frq-SE_frq, ymax=estimate_frq+SE_frq, colour=change_in_occurance), width = 0)
p <- p + geom_hline(aes(yintercept=0), linetype="dashed")
p <- p + theme(panel.grid.minor = element_blank(),
               panel.background = element_blank(),
               axis.line = element_line(colour = "black")) +
    theme(panel.border=element_rect(colour = "black", fill = "NA", size = 1)) +
    theme(axis.text.y=element_text(angle= 360, hjust = 0.5, vjust = 0.5, size =14),
          axis.title.y=element_text(size=22, vjust = 1),
          axis.text.x=element_text(face = "italic", angle= 90, hjust = 0, vjust = 0.5, size =7),
          axis.title.x=element_text(size=22, vjust = 1),
          axis.text=element_text(colour = "black"))+
    theme(strip.background = element_rect(colour="NA", fill=NA),
          strip.text = element_text(size=16))
p <- p + theme(axis.title.y=element_text(margin=margin(0,20,0,0)))
p <- p + scale_colour_brewer(palette = "Dark2")
p$labels$colour <- "Change in occurance"
p

####################################################
#END
####################################################

```

Figure 5. Model estimated changes (± 1 SE) in the relative occurance frequencey for diffent New Zealand bee and fly species in museum collections over time.

- Do we need some sort of separate discussion or integrate into the results section? i would say integrate!
… Although this is surprising, it could simply indicate a change in the evenness of species collected over time as the method we used actually measures both richness and evenness. Yes.


## The way forward  

As illustrated in our examples, unleashing the power of museum collection data to answer pressing questions is at our hands, but requires the coordinated effort of many actors. Using two case studies, we show that collaboration with both museum curators and data collectors is key to adequately understanding the data and treating it appropriately. We envision that instead of a central museum collection record repository, researchers and curators should simply aim to make digitalized data readily available and easy to share. Ultimately, centralisation of these data in existing platforms such as Gbif would facilitate free and widespread access. However, even when data are stored in different webpages or databases, it can be retrieved and combined with other datasets using open science tools (#@ropensci), providing these tools are accessible [API e.g., #@heltmint].   

We also need to revolutionize the way that researchers collaborate with museums, which should start with fostering healthy bidirectional relationships. For instance, researchers collect massive amounts of specimens, but these are often inappropriately vouchered, rendering them useless for research purposes. To improve this, strong communication between museums and researchers is required, but this will only be achieved if there is not adequate funding, and recognition that accurate data recording and long-term preservation are critical for research.

Ultimately, to identify global trends in pollinator declines we require robust data, collected from diverse geographic regions. Further, it is crucial that data are analysed in the appropriate way. This requires researches identifying biases and filling in gaps where possible. We need to put increased emphasis on quantifying pollinator declines in regions outside of the US and Europe and for pollinator groups other than bees. For the US and Europe there have been few regional bee extinctions [@Ollerton; @Bartomeus2013c] (#check this Bartomeus reference), but declines are widespread in disturbed ecosystems [@Bartomeus2013a; @DePalma2017; @Carvalheiro2013]. For most other pollinator taxa and regions throughout the world we know almost nothing. Moving forward, the first step for many taxa will be to identify and describe species. Only then can we begin to document declines.  

#Acknowledgements  

We thank E. Asensio (or maybe coauthor?), Curro Molina,  Patrick McQuinn, and Crona McMonagle for data entry. Madrid museum, ITACyL. We also thank Barry Donovan for providing New Zealand bee collection records and Carola Warner for entering the New Zealand data.

#References



