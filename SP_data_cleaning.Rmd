---
title: "SP"
author: "I. Bartomeus"
date: "05/10/2017"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Notas:

- 'Localidades?': Info per species. Recorded only at the first record of each species. Refers to geograpfic known records. Usefull for abejassilvestres.es ?
- 'obrera' needs to be merged with 'sex'
- ID and 'cuaderno' need to remove duplicates, which are not in cuaderno!!
- IF several IT's Oscar Aguado duplicated the enetry as many times as need. Those sp are in red in original excel.


Old data:

```{r}
sp <- read.csv(file = "raw_data/Spain.csv", h = T)
head(sp)
head(sort(table(sp$LOCALIDAD), decreasing = TRUE))
#write.csv(sort(table(sp$LOCALIDAD), decreasing = TRUE),
 #         "raw_data/localidades.csv")

sp$gen_sp <- paste(sp$G.NERO, sp$ESPECIE, sep = "_")
unique(sp$gen_sp) #721 species! #clean, but only for the subset of used data. The 7 localities.
head(sort(table(sp$gen_sp), decreasing = TRUE), 50)

#subset only the 7 localities.

sp2 <- subset(sp, LOCALIDAD %in% c('"Finca Zamadue?as"',
                            "Toro",
                            "Granja Escuela Jose Antonio",
                            "Villab??ez",
                            '""Finca Zamadue?as""',
                            "Hornillos",
                            '"Camino Hondo" Granja Escuela Jose Antonio',
                            "Parc. 16 Granja Escuela Jose Antonio",
                            "Mojados",
                            "Coto Bajo Matallana",
                            "San llorente",
                            "San Llorente",
                            "_Finca Zamadue?as_",
                            "La Senovilla Olmedo",
                            "Coto Bajo de Matallana Villalba de los Alcores",
                            "Mojados",
                            "Olmedo",
                            "Coto Bajo Matallana Villalba de los Alcores",
                            "Las Fuentes Mojados",
                            "Paramo de Matallana",
                            "Villalba de los Alcores",
                            "_Coto Bajo de Matallana_",
                            "_Coto Bajo de Matallana_",
                            "Coto Bajo de Matallana Montealegre",
                            "Coto Bajo Matallana",
                            "Las Fuentes  Mojados",
                            "P?ramo de Matallana Villanubla",
                            "Olmedo"))

head(sp2)

sp2 <- droplevels(sp2)
levels(sp2$LOCALIDAD) <- c("zamaduenas",
                           "auditorio_Delibes", 
                           "zamaduenas",
                           "auditorio_Delibes",
                           "hornillos",
                           "olmedo",
                           "olmedo",
                           "auditorio_Delibes",
                           "sanbernardo",
                           "sanbernardo",
                           "toro",
                           "vilalba",
                           "vilalba")


#check sampling completness
library(vegan)
#need to fix first locality
head(sp2)
comm <- table(sp2$LOCALIDAD, sp2$gen_sp)
temp <- specaccum(comm, "random")
summary(temp)
plot(temp)
rarecurve(comm)

```

New data:

```{r}
now <- read.csv(file = "raw_data/Spain_2016.csv", h = T)
head(now)
table(now$LOCALIDAD)
levels(now$LOCALIDAD) <- c("auditorio_Delibes",
                           "auditorio_Delibes",
                           "hornillos",
                           "hornillos",
                           "olmedo",
                           "sanbernardo",
                           "toro",
                           "vilalba",
                           "zamaduenas")
#get lat long
library(spatial)
#biogeomancer(country = "Spain", adm1 = "Castilla y Leon", adm2 = "Valladolid", 
#             locality = levels(now$LOCALIDAD), 
#             singleRecord=TRUE, progress="text")
#not working, but Ropen sci has alternative packages.
now$gen_sp <- paste(now$GÃ‰NERO, now$ESPECIE, sep = "_")
sort(table(now$gen_sp))
#clean species
unique(now$gen_sp) #197!!! but still some duplicates 

#check sampling completness
library(vegan)
comm <- table(now$LOCALIDAD, now$gen_sp)
temp <- specaccum(comm, "random")
summary(temp)
plot(temp)
rarecurve(comm) #uf... not really well sampled... but ~80 species per site it's quite good!
```

Data Gbif:
```{r}
gbif <- read.csv(file = "raw_data/data_gbif.csv", h = T)
head(gbif)
hist(gbif$year) #nice, bimodal!
sort(table(gbif$recordedBy), decreasing = TRUE)
#Engel, M, Hinojosa, I, Bennett, D, & Davis, S
#G.E. Bohart
#Torchio, Asensio, etc...
#Baker, D. & Baker, M.
# see
set <- which(gbif$recordedBy == "Engel, M, Hinojosa, I, Bennett, D, & Davis, S")
library(mapr)
colnames(gbif)[2:3] <- c("latitude", "longitude") 
map_leaflet(gbif[set,]) #interesting, 
# Engel collected in 2007 in the south! And taxonomy is bad!
# Baker in Estartit #del 62! 
# Bohart Madrid, islands, south... in 78's

#Overall, most pre 1980 collections around valladolid.
head(sort(table(gbif$species), decreasing = TRUE), 50)
unique(gbif$species) #443! BUT here lots of duplicates?
```

#Analysis

```{r}
#make final dataset
sp3 <- sp2[,c("LOCALIDAD", "gen_sp", "NUM_EJEMPLARES")]
now3 <- now[, c("LOCALIDAD", "gen_sp")]
now3$NUM_EJEMPLARES <- 1
now3$when <- "now"
sp3$when <- "asensio"

library(lettercase)
str_ucfirst(str_lower_case(sp3$gen_sp[1:10]))


sp3$gen_sp <- str_ucfirst(str_lower_case(sp3$gen_sp))

dat <- rbind(sp3, now3)
#check stuff
head(dat)
unique(dat$gen_sp) #400
#this can be cleaned, but looks decent!

colnames(dat) <- c("locality", "gen_sp", "freq", "when")
unique(dat$locality) #400

write.csv(dat, "data/spain_clean.csv", row.names = F)
```


1) only for 7 localities, join now and then and paired t-test on rarefied richness per site

1.1) Show raref per site

2) For common species we can do the same but with standardized frequency.









